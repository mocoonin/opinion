<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opinion æ‰¹é‡æŸ¥è¯¢å·¥å…· v1.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }

        .header-left h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-left p {
            color: #888;
            font-size: 0.9em;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(40, 44, 66, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .icon-btn:hover {
            background: rgba(50, 54, 76, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .lang-btn {
            width: 70px;
            height: 50px;
            padding: 0;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .refresh-btn {
            width: auto;
            min-width: 140px;
            padding: 0 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn svg {
            flex-shrink: 0;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1e3a;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .modal-body input,
        .modal-body textarea {
            width: 100%;
            padding: 12px;
            background: #0a0e27;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .modal-body textarea {
            min-height: 300px;
            resize: vertical;
        }

        .modal-body input:focus,
        .modal-body textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-count {
            text-align: right;
            color: #666;
            font-size: 0.85em;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #ffa726;
            color: #000;
        }

        .btn-primary:hover {
            background: #ff9800;
        }

        .btn-secondary {
            background: #333;
            color: #aaa;
        }

        .btn-secondary:hover {
            background: #444;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .results-table {
            background: #1a1e3a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #0a0e27;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #333;
        }

        tbody tr {
            border-bottom: 1px solid #2a2e4a;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #222645;
        }

        tbody tr.expandable {
            cursor: pointer;
        }

        td {
            padding: 15px 12px;
            font-size: 0.9em;
        }

        .address-cell {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #aaa;
        }

        .expand-icon {
            transition: transform 0.3s;
            display: inline-block;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .detail-row {
            display: none;
            background: #0a0e27;
        }

        .detail-row.expanded {
            display: table-row;
        }

        .detail-content {
            padding: 20px;
        }

        .timeline-compact {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .day-mini {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
        }

        .day-mini.qualified {
            background: #4caf50;
            color: white;
        }

        .day-mini.partially-qualified {
            background: #ffa726;
            color: white;
        }

        .day-mini.not-qualified {
            background: #f44336;
            color: white;
        }

        .day-mini:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .tooltip {
            position: absolute;
            background: #000;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
        }

        .day-mini:hover .tooltip {
            opacity: 1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #3d1a1a;
            border: 1px solid #ff4444;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            color: #ff6b6b;
        }

        /* æ‚¬æµ®æŒ‰é’® */
        .float-btn {
            position: fixed;
            right: 20px;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 16px;
            cursor: move;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.4);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .float-btn.show {
            display: flex;
        }

        .float-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 18px rgba(102, 126, 234, 0.6);
        }

        .float-btn:active {
            cursor: grabbing;
        }

        .expand-btn {
            top: calc(50% - 45px);
        }

        .collapse-btn {
            top: calc(50% + 5px);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            th, td {
                padding: 10px 8px;
                font-size: 0.8em;
            }
        }

        .important-notice {
            background: linear-gradient(135deg, rgba(255, 167, 38, 0.2) 0%, rgba(251, 140, 0, 0.2) 100%);
            border: 2px solid #ffa726;
            border-radius: 10px;
            padding: 20px 30px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            animation: pulse 2s ease-in-out infinite;
            min-height: 80px;
        }

        .important-notice-icon {
            font-size: 36px;
            flex-shrink: 0;
        }

        .important-notice-text {
            color: #ffa726;
            font-size: 1.4em;
            font-weight: 600;
            line-height: 1.4;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 167, 38, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(255, 167, 38, 0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 data-i18n="title">ğŸ“Š Opinion æ‰¹é‡æŸ¥è¯¢å·¥å…·</h1>
                <p data-i18n="subtitle">2025-12-22 è‡³ 2026-01-05 äº¤æ˜“æ•°æ®åˆ†æ</p>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="window.open('https://x.com/Mocoonin', '_blank')" title="Twitter">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="openWalletModal()" title="é’±åŒ…ç®¡ç†">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="5" width="20" height="14" rx="2"/>
                        <path d="M2 10h20"/>
                    </svg>
                </button>
                <button class="icon-btn lang-btn" onclick="toggleLanguage()" title="åˆ‡æ¢è¯­è¨€">
                    <span id="langText" style="font-size: 14px; font-weight: 600;">ä¸­æ–‡</span>
                </button>
                <button class="icon-btn refresh-btn" onclick="queryAddresses()" title="åˆ·æ–°æ•°æ®">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    <span style="margin-left: 8px;" data-i18n="refresh">åˆ·æ–°æ•°æ®</span>
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p data-i18n="loading">æ­£åœ¨æŸ¥è¯¢ <span id="progress">0/0</span>...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" class="results-table" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 60px;" data-i18n="th_no">åºå·</th>
                        <th data-i18n="th_address">é’±åŒ…åœ°å€</th>
                        <th style="width: 140px; padding-left: 2px;" data-i18n="th_wallet_assets">é’±åŒ…èµ„äº§</th>
                        <th style="width: 120px;" data-i18n="th_remark">å¤‡æ³¨</th>
                        <th style="width: 120px;" data-i18n="th_today_volume">ä»Šæ—¥äº¤æ˜“é‡</th>
                        <th style="width: 160px;" data-i18n="th_today_gap">ä»Šæ—¥å·®é¢</th>
                        <th style="width: 120px;" data-i18n="th_volume">æ€»äº¤æ˜“é¢</th>
                        <th style="width: 100px;" data-i18n="th_qualified">è¾¾æ ‡å¤©æ•°</th>
                        <th style="width: 180px;" data-i18n="th_status">è¾¾æ ‡çŠ¶æ€</th>
                        <th style="width: 120px;" data-i18n="th_detail">æ¯æ—¥è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- é’±åŒ…é…ç½®æ¨¡æ€æ¡† -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    <span data-i18n="wallet_config">é’±åŒ…é…ç½®</span>
                </div>
                <button class="modal-close" onclick="closeWalletModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <label>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    <span data-i18n="api_key_label">API Key:</span>
                </label>
                <input type="password" id="modalApiKey" placeholder="è¾“å…¥ä½ çš„ API Key">
                
                <label>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    <span data-i18n="wallet_label">é’±åŒ…åœ°å€ (æ¯è¡Œä¸€ä¸ª):</span>
                </label>
                <div style="font-size: 0.85em; color: #888; margin-bottom: 8px; line-height: 1.5;">
                    <span data-i18n="wallet_hint">è¯·è¾“å…¥æ³¨å†Œ Opinion æ—¶ä½¿ç”¨çš„é’±åŒ…åœ°å€ç”¨äºæŸ¥è¯¢æ•°æ®,æ¯è¡Œä¸€ä¸ª,åœ°å€å’Œå¤‡æ³¨ä¸­é—´æ˜¯ç©ºæ ¼ã€‚</span>
                </div>
                <div class="char-count">
                    <span id="walletCount">0</span> / 100 <span data-i18n="max_wallets">ä¸ªåœ°å€</span>
                </div>
                <textarea id="modalAddresses" placeholder="0x1234...&#10;0x5678... é’±åŒ…1&#10;0x9abc... ä¸»é’±åŒ…" oninput="updateWalletCount()"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeWalletModal()" data-i18n="cancel">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveWalletConfig()" data-i18n="save">ä¿å­˜</button>
            </div>
        </div>
    </div>


    <!-- æ‚¬æµ®å±•å¼€/æŠ˜å æŒ‰é’® -->
    <button id="expandAllBtn" class="float-btn expand-btn" title="å±•å¼€å…¨éƒ¨">
        <span>â–¼</span>
    </button>
    <button id="collapseAllBtn" class="float-btn collapse-btn" title="æŠ˜å å…¨éƒ¨">
        <span>â–²</span>
    </button>

    <script>
        // é…ç½®
        const API_BASE = 'https://openapi.opinion.trade/openapi';
        const START_DATE = new Date('2025-12-22T00:00:00Z');
        const END_DATE = new Date('2026-01-05T23:59:59Z');
        const MIN_TRADES_PER_DAY = 4; // ä¿®æ­£ä¸º4æ¬¡
        const MIN_VOLUME_PER_DAY = 2000;
        const MIN_QUALIFIED_DAYS = 11; // ä¿®æ­£ä¸º11å¤©
        const MIN_TOTAL_VOLUME = 2000;
        const MAX_WALLETS = 100;
        const CACHE_KEY_PREFIX = 'opinion_cache_';
        const CACHE_VERSION = 'v2'; // ç¼“å­˜ç‰ˆæœ¬å·

        let allResults = [];
        let allExpanded = false;
        let currentLang = 'zh';
        let currentUTC0Date = null; // å½“å‰UTC+0æ—¥æœŸï¼Œç”¨äºåˆ¤æ–­"ä»Šå¤©åŠæœªæ¥"

        // ==================== ç¼“å­˜ç®¡ç† ====================
        // æ¸…é™¤æ—§ç‰ˆæœ¬ç¼“å­˜
        (function clearOldCache() {
            const currentVersion = localStorage.getItem('opinion_cache_version');
            if (currentVersion !== CACHE_VERSION) {
                console.log('[ç¼“å­˜] æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ç¼“å­˜,æ­£åœ¨æ¸…é™¤...');
                Object.keys(localStorage)
                    .filter(key => key.startsWith(CACHE_KEY_PREFIX))
                    .forEach(key => localStorage.removeItem(key));
                localStorage.setItem('opinion_cache_version', CACHE_VERSION);
                console.log('[ç¼“å­˜] æ—§ç¼“å­˜å·²æ¸…é™¤,ç‰ˆæœ¬å·²æ›´æ–°ä¸º', CACHE_VERSION);
            }
        })();

        // è·å–UTC+0å½“å‰æ—¥æœŸ (ç›´æ¥ä½¿ç”¨æœ¬åœ°UTCæ—¶é—´)
        function getTodayUTC0() {
            const utcDate = new Date().toISOString().split('T')[0];
            console.log(`[æ—¶åŒº] å½“å‰UTC+0æ—¥æœŸ: ${utcDate}`);
            return utcDate;
        }

        // è·å–ç¼“å­˜é”®
        function getCacheKey(address, date) {
            return `${CACHE_KEY_PREFIX}${address}_${date}`;
        }

        // ä¿å­˜åˆ°ç¼“å­˜
        function saveToCache(address, date, data) {
            const today = getTodayUTC0();
            if (date < today) {
                try {
                    const key = getCacheKey(address, date);
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.warn('ç¼“å­˜ä¿å­˜å¤±è´¥:', e);
                }
            }
        }

        // ä»ç¼“å­˜è¯»å–
        function getFromCache(address, date) {
            const today = getTodayUTC0();
            const shouldCache = date < today;
            console.log(`[ç¼“å­˜] æ—¥æœŸ: ${date}, ä»Šå¤©: ${today}, å¯ç¼“å­˜: ${shouldCache}`);
            
            if (shouldCache) {
                try {
                    const key = getCacheKey(address, date);
                    const cached = localStorage.getItem(key);
                    if (cached) {
                        console.log(`[ç¼“å­˜] âœ“ å‘½ä¸­ç¼“å­˜: ${date}`);
                        return JSON.parse(cached);
                    }
                } catch (e) {
                    console.warn('ç¼“å­˜è¯»å–å¤±è´¥:', e);
                }
            }
            return null;
        }

        // æ˜¾ç¤ºç¼“å­˜çŠ¶æ€æç¤º
        function showCacheStatus() {
            // ç®€å•æç¤º,ä¸å½±å“UI
            console.log('âœ“ ä½¿ç”¨ç¼“å­˜æ•°æ®åŠ é€ŸæŸ¥è¯¢');
        }

        // å›½é™…åŒ–æ–‡æœ¬
        const i18n = {
            zh: {
                title: 'ğŸ“Š Opinion æ‰¹é‡æŸ¥è¯¢å·¥å…·',
                subtitle: '2025-12-22 è‡³ 2026-01-05 (UTC+0) | v1.7',
                refresh: 'åˆ·æ–°æ•°æ®',
                loading: 'æ­£åœ¨æŸ¥è¯¢',
                th_no: 'åºå·',
                th_address: 'é’±åŒ…åœ°å€',
                th_wallet_assets: 'é’±åŒ…èµ„äº§',
                th_remark: 'å¤‡æ³¨',
                th_today_volume: 'ä»Šæ—¥äº¤æ˜“é‡',
                th_today_gap: 'ä»Šæ—¥å·®é¢',
                th_volume: 'æ€»äº¤æ˜“é¢',
                th_qualified: 'è¾¾æ ‡å¤©æ•°',
                th_status: 'è¾¾æ ‡çŠ¶æ€',
                th_detail: 'æ¯æ—¥è¯¦æƒ…',
                wallet_config: 'é’±åŒ…é…ç½®',
                api_key_label: 'API Key:',
                wallet_label: 'é’±åŒ…åœ°å€ (æ¯è¡Œä¸€ä¸ª):',
                wallet_hint: 'è¯·è¾“å…¥æ³¨å†Œ Opinion æ—¶ä½¿ç”¨çš„é’±åŒ…åœ°å€ç”¨äºæŸ¥è¯¢æ•°æ®,æ¯è¡Œä¸€ä¸ª,åœ°å€å’Œå¤‡æ³¨ä¸­é—´æ˜¯ç©ºæ ¼ã€‚',
                max_wallets: 'ä¸ªåœ°å€',
                cancel: 'å–æ¶ˆ',
                save: 'ä¿å­˜',
                view: 'æŸ¥çœ‹',
                daily_warrior: 'æ¯æ—¥æˆ˜å£«',
                volume_king: 'äº¤æ˜“é‡ç‹è€…',
                qualified: 'å·²è¾¾æ ‡',
                not_qualified: 'æœªè¾¾æ ‡',
                no_more_chance: 'âš ï¸ å‰©ä½™æ—¶é—´ä¸è¶³,æ— æ³•è¾¾æ ‡',
                already_qualified: 'âœ“ å·²å®Œæˆè¾¾æ ‡è¦æ±‚',
                need_more: 'è¿˜å·®',
                days: 'å¤©'
            },
            en: {
                title: 'ğŸ“Š Opinion Batch Query Tool',
                subtitle: '2025-12-22 to 2026-01-05 (UTC+0) | v1.1',
                refresh: 'Refresh',
                loading: 'Querying',
                th_no: 'No.',
                th_address: 'Wallet Address',
                th_wallet_assets: 'Wallet Assets',
                th_remark: 'Remark',
                th_today_volume: 'Today Volume',
                th_today_gap: 'Today Gap',
                th_volume: 'Total Volume',
                th_qualified: 'Qualified Days',
                th_status: 'Status',
                th_detail: 'Details',
                wallet_config: 'Wallet Config',
                api_key_label: 'API Key:',
                wallet_label: 'Wallet Addresses (one per line):',
                wallet_hint: 'Enter wallet addresses used to register Opinion for data query, one per line, address and note separated by space.',
                max_wallets: 'addresses',
                cancel: 'Cancel',
                save: 'Save',
                view: 'View',
                daily_warrior: 'Daily Warrior',
                volume_king: 'Volume King',
                qualified: 'Qualified',
                not_qualified: 'Not Qualified',
                no_more_chance: 'âš ï¸ Not enough time left',
                already_qualified: 'âœ“ Requirements met',
                need_more: 'Need',
                days: 'more days'
            }
        };

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            const hasConfig = localStorage.getItem('opinion_api_key') && localStorage.getItem('opinion_addresses');
            if (!hasConfig) {
                openWalletModal();
            } else {
                queryAddresses();
            }
            initFloatButton();
        });

        // å›½é™…åŒ–
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            document.getElementById('langText').textContent = currentLang === 'zh' ? 'ä¸­æ–‡' : 'EN';
            updateI18n();
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ›´æ–°å±•å¼€è¯¦æƒ…ä¸­çš„æ–‡æœ¬
            if (allResults.length > 0) {
                displayResults();
            }
        }

        function updateI18n() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) {
                    el.textContent = i18n[currentLang][key];
                }
            });
        }

        // é’±åŒ…æ¨¡æ€æ¡†
        function openWalletModal() {
            const savedApiKey = localStorage.getItem('opinion_api_key') || '';
            const savedAddresses = localStorage.getItem('opinion_addresses') || '';
            
            document.getElementById('modalApiKey').value = savedApiKey;
            document.getElementById('modalAddresses').value = savedAddresses;
            updateWalletCount();
            
            document.getElementById('walletModal').classList.add('show');
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('show');
        }


        function updateWalletCount() {
            const text = document.getElementById('modalAddresses').value;
            const lines = text.split('\n').filter(line => line.trim() && line.trim().startsWith('0x'));
            document.getElementById('walletCount').textContent = lines.length;
            
            if (lines.length > MAX_WALLETS) {
                document.getElementById('walletCount').style.color = '#ff4444';
            } else {
                document.getElementById('walletCount').style.color = '#4caf50';
            }
        }

        function saveWalletConfig() {
            const apiKey = document.getElementById('modalApiKey').value.trim();
            const addresses = document.getElementById('modalAddresses').value.trim();
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }
            
            if (!addresses) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªé’±åŒ…åœ°å€');
                return;
            }
            
            const lines = addresses.split('\n').filter(line => line.trim() && line.trim().startsWith('0x'));
            if (lines.length > MAX_WALLETS) {
                alert(`æœ€å¤šåªèƒ½æ·»åŠ  ${MAX_WALLETS} ä¸ªåœ°å€`);
                return;
            }
            
            localStorage.setItem('opinion_api_key', apiKey);
            localStorage.setItem('opinion_addresses', addresses);
            
            closeWalletModal();
            queryAddresses();
        }

        // æ‚¬æµ®æŒ‰é’®
        function initFloatButton() {
            const expandBtn = document.getElementById('expandAllBtn');
            const collapseBtn = document.getElementById('collapseAllBtn');

            let isDragging = false;
            let startX, startY;
            let initialExpandTop, initialCollapseTop;
            let hasMoved = false;

            [expandBtn, collapseBtn].forEach(btn => {
                btn.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    hasMoved = false;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // è·å–å½“å‰ä½ç½®
                    const expandRect = expandBtn.getBoundingClientRect();
                    const collapseRect = collapseBtn.getBoundingClientRect();
                    initialExpandTop = expandRect.top;
                    initialCollapseTop = collapseRect.top;
                    
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                // åˆ¤æ–­æ˜¯å¦çœŸçš„ç§»åŠ¨äº†
                if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) {
                    hasMoved = true;
                }
                
                // è®¡ç®—æ–°ä½ç½®
                const newExpandTop = initialExpandTop + deltaY;
                const newCollapseTop = initialCollapseTop + deltaY;
                const newLeft = e.clientX - 19; // å‡å»æŒ‰é’®åŠå¾„
                
                // æ›´æ–°ä½ç½®
                expandBtn.style.left = newLeft + 'px';
                expandBtn.style.top = newExpandTop + 'px';
                expandBtn.style.right = 'auto';
                
                collapseBtn.style.left = newLeft + 'px';
                collapseBtn.style.top = newCollapseTop + 'px';
                collapseBtn.style.right = 'auto';
            });

            document.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                
                // å¦‚æœæ²¡æœ‰ç§»åŠ¨,æ‰§è¡Œç‚¹å‡»
                if (!hasMoved) {
                    if (e.target.closest('#expandAllBtn')) {
                        expandAll();
                    } else if (e.target.closest('#collapseAllBtn')) {
                        collapseAll();
                    }
                } else {
                    // æ‹–åŠ¨ç»“æŸ,å¸é™„åˆ°å·¦å³
                    const centerX = window.innerWidth / 2;
                    const expandRect = expandBtn.getBoundingClientRect();
                    const btnCenterX = expandRect.left + expandRect.width / 2;
                    
                    if (btnCenterX < centerX) {
                        // å¸é™„åˆ°å·¦è¾¹
                        expandBtn.style.left = '20px';
                        expandBtn.style.right = 'auto';
                        collapseBtn.style.left = '20px';
                        collapseBtn.style.right = 'auto';
                    } else {
                        // å¸é™„åˆ°å³è¾¹
                        expandBtn.style.right = '20px';
                        expandBtn.style.left = 'auto';
                        collapseBtn.style.right = '20px';
                        collapseBtn.style.left = 'auto';
                    }
                }
                
                isDragging = false;
            });
        }

        function expandAll() {
            document.querySelectorAll('.detail-row').forEach((row, index) => {
                const iconEl = document.getElementById(`icon-${index + 1}`);
                row.classList.add('expanded');
                if (iconEl) iconEl.classList.add('expanded');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.detail-row').forEach((row, index) => {
                const iconEl = document.getElementById(`icon-${index + 1}`);
                row.classList.remove('expanded');
                if (iconEl) iconEl.classList.remove('expanded');
            });
        }

        // API è°ƒç”¨ (çœç•¥,ä¸ä¹‹å‰ç›¸åŒ)
        function getDateRange() {
            const dates = [];
            // ä½¿ç”¨ UTC æ—¶é—´,é¿å…æ—¶åŒºé—®é¢˜
            const start = new Date(Date.UTC(2025, 11, 22));  // æœˆä»½ä»0å¼€å§‹,11=12æœˆ
            const end = new Date(Date.UTC(2026, 0, 5));      // 0=1æœˆ
            
            let current = new Date(start);
            while (current <= end) {
                dates.push(new Date(current));
                current = new Date(current.getTime() + 24 * 60 * 60 * 1000);  // åŠ ä¸€å¤©
            }
            return dates;
        }

        function formatDateFull(date) {
            return date.toISOString().split('T')[0];
        }

        function parseAddresses(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const addresses = [];
            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length > 0 && parts[0].startsWith('0x')) {
                    addresses.push({
                        address: parts[0],
                        remark: parts.slice(1).join(' ') || ''
                    });
                }
            }
            return addresses;
        }

        async function fetchUserTrades(address, apiKey) {
            // æœ¬åœ°ç‰ˆæœ¬: ç›´æ¥è°ƒç”¨Opinion API
            const url = `${API_BASE}/trade/user/${address}`;
            let allTrades = [];
            let page = 1;
            const limit = 20;
            
            while (true) {
                const response = await fetch(`${url}?page=${page}&limit=${limit}`, {
                    headers: { 'apikey': apiKey }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.errno !== 0) throw new Error(data.errmsg || 'APIé”™è¯¯');

                const trades = data.result?.list || [];
                allTrades = allTrades.concat(trades);

                if (trades.length < limit || allTrades.length >= (data.result?.total || 0)) break;
                page++;
                if (page > 100) break;
            }

            return allTrades;
        }

        function filterTradesByDateRange(trades) {
            return trades.filter(trade => {
                const tradeTime = trade.createdAt * 1000;
                return tradeTime >= START_DATE.getTime() && tradeTime <= END_DATE.getTime();
            });
        }

        function groupTradesByDate(trades) {
            const groups = {};
            trades.forEach(trade => {
                const dateStr = formatDateFull(new Date(trade.createdAt * 1000));
                if (!groups[dateStr]) groups[dateStr] = [];
                groups[dateStr].push(trade);
            });
            return groups;
        }

        function calculateDailyStats(trades) {
            const tradeCount = trades.length;
            let totalVolume = 0;
            trades.forEach(trade => {
                totalVolume += parseFloat(trade.amount || 0);
            });

            const isCountQualified = tradeCount >= MIN_TRADES_PER_DAY;
            const isVolumeQualified = totalVolume >= MIN_VOLUME_PER_DAY;
            const isQualified = isCountQualified && isVolumeQualified;
            const isPartiallyQualified = !isQualified && (isCountQualified || isVolumeQualified);

            return { 
                tradeCount, 
                totalVolume, 
                isQualified,
                isPartiallyQualified,
                isCountQualified,
                isVolumeQualified
            };
        }

        async function analyzeAddress(addressInfo, apiKey) {
            const { address, remark } = addressInfo;

            try {
                const dates = getDateRange();
                const dailyStats = {};
                let usedCache = false;

                // å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½å†å²æ•°æ®
                dates.forEach(date => {
                    const dateStr = formatDateFull(date);
                    const cached = getFromCache(address, dateStr);
                    if (cached) {
                        dailyStats[dateStr] = cached;
                        usedCache = true;
                    }
                });

                // è·å–éœ€è¦å®æ—¶æŸ¥è¯¢çš„æ—¥æœŸ
                const needFetchDates = dates.filter(date => {
                    const dateStr = formatDateFull(date);
                    return !dailyStats[dateStr];
                });

                // å¦‚æœæœ‰éœ€è¦æŸ¥è¯¢çš„æ—¥æœŸ,åˆ™æŸ¥è¯¢API
                if (needFetchDates.length > 0) {
                    const allTrades = await fetchUserTrades(address, apiKey);
                    const trades = filterTradesByDateRange(allTrades);
                    const tradesByDate = groupTradesByDate(trades);
                    
                    needFetchDates.forEach(date => {
                        const dateStr = formatDateFull(date);
                        const dayTrades = tradesByDate[dateStr] || [];
                        const stats = calculateDailyStats(dayTrades);
                        
                        dailyStats[dateStr] = stats;
                        
                        // ä¿å­˜åˆ°ç¼“å­˜(åªç¼“å­˜ä»Šæ—¥ä¹‹å‰çš„æ•°æ®)
                        saveToCache(address, dateStr, stats);
                    });
                }

                if (usedCache) {
                    showCacheStatus();
                }

                // è®¡ç®—æ±‡æ€»ç»Ÿè®¡
                let totalVolume = 0;
                let qualifiedDays = 0;
                let partiallyQualifiedDays = 0;

                dates.forEach(date => {
                    const dateStr = formatDateFull(date);
                    const stats = dailyStats[dateStr];
                    if (stats) {
                        totalVolume += stats.totalVolume;
                        if (stats.isQualified) qualifiedDays++;
                        if (stats.isPartiallyQualified) partiallyQualifiedDays++;
                    }
                });

                const awards = {
                    dailyWarriors: qualifiedDays >= MIN_QUALIFIED_DAYS,
                    volumeKings: qualifiedDays >= MIN_QUALIFIED_DAYS
                };

                return {
                    address,
                    remark,
                    dailyStats,
                    summary: {
                        totalVolume,
                        qualifiedDays,
                        partiallyQualifiedDays,
                        totalDays: dates.length,
                        awards
                    }
                };
            } catch (error) {
                console.error(`åˆ†æåœ°å€ ${address} æ—¶å‡ºé”™:`, error);
                return {
                    address,
                    remark,
                    error: error.message
                };
            }
        }

        async function queryAddresses() {
            const apiKey = localStorage.getItem('opinion_api_key');
            const text = localStorage.getItem('opinion_addresses');

            if (!apiKey || !text) {
                openWalletModal();
                return;
            }

            const addressInfos = parseAddresses(text);
            if (addressInfos.length === 0) {
                showError('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åœ°å€');
                return;
            }

            // è·å–UTC+0å½“å‰æ—¥æœŸï¼Œç”¨äºåˆ¤æ–­"ä»Šå¤©åŠæœªæ¥"
            currentUTC0Date = getTodayUTC0();

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            
            const expandBtn = document.getElementById('expandAllBtn');
            const collapseBtn = document.getElementById('collapseAllBtn');
            if (expandBtn) expandBtn.classList.remove('show');
            if (collapseBtn) collapseBtn.classList.remove('show');

            allResults = [];

            try {
                for (let i = 0; i < addressInfos.length; i++) {
                    const progressEl = document.getElementById('progress');
                    if (progressEl) {
                        progressEl.textContent = `${i + 1}/${addressInfos.length}`;
                    }
                    const result = await analyzeAddress(addressInfos[i], apiKey);
                    allResults.push(result);
                }

                document.getElementById('loading').style.display = 'none';
                displayResults();
                if (expandBtn) expandBtn.classList.add('show');
                if (collapseBtn) collapseBtn.classList.add('show');
            } catch (error) {
                console.error('æŸ¥è¯¢é”™è¯¯:', error);
                document.getElementById('loading').style.display = 'none';
                showError(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
            }
        }
        // è·å–è´¦æˆ·ä¿¡æ¯
        async function fetchAccountInfo(address) {
            try {
                const response = await fetch(
                    `https://proxy.opinion.trade:8443/api/bsc/api/v2/user/${address}/profile?chainId=56`
                );
                
                if (!response.ok) {
                    return { balance: 0, netWorth: 0, portfolio: 0 };
                }
                
                const data = await response.json();
                if (data.errno !== 0) {
                    return { balance: 0, netWorth: 0, portfolio: 0 };
                }
                
                const result = data.result;
                let totalBalance = 0;
                if (result.balance && Array.isArray(result.balance) && result.balance.length > 0) {
                    totalBalance = parseFloat(result.balance[0].totalBalance || 0);
                }
                
                return {
                    balance: totalBalance,
                    netWorth: parseFloat(result.netWorth || 0),
                    portfolio: parseFloat(result.portfolio || 0)
                };
            } catch (e) {
                console.error(`è·å–${address}è´¦æˆ·ä¿¡æ¯å¤±è´¥:`, e);
                return { balance: 0, netWorth: 0, portfolio: 0 };
            }
        }


        function displayResults() {
            if (allResults.length === 0) return;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            allResults.forEach((result, index) => {
                if (result.error) {
                    tbody.innerHTML += createErrorRow(result, index + 1);
                } else {
                    tbody.innerHTML += createTableRow(result, index + 1);
                    tbody.innerHTML += createDetailRow(result, index + 1);
                }
            });

            document.getElementById('results').style.display = 'block';
            
            // å¼‚æ­¥åŠ è½½è´¦æˆ·ä¿¡æ¯
            allResults.forEach((result, idx) => {
                if (!result.error && result.address) {
                    setTimeout(() => {
                        fetchAccountInfo(result.address).then(info => {
                            const cell = document.getElementById(`account-${result.address}`);
                            if (!cell) return;
                            
                            const portSpan = cell.querySelector('.portfolio-val');
                            const balSpan = cell.querySelector('.balance-val');
                            const netSpan = cell.querySelector('.networth-val');
                            
                            if (portSpan && info.portfolio !== undefined) {
                                portSpan.textContent = `$${(info.portfolio || 0).toFixed(2)}`;
                                portSpan.style.color = info.portfolio > 0 ? '#ffa726' : '#666';
                            }
                            if (balSpan && info.balance !== undefined) {
                                balSpan.textContent = `$${(info.balance || 0).toFixed(2)}`;
                                balSpan.style.color = info.balance > 0 ? '#4caf50' : '#666';
                            }
                            if (netSpan && info.netWorth !== undefined) {
                                netSpan.textContent = `$${(info.netWorth || 0).toFixed(2)}`;
                                netSpan.style.color = info.netWorth > 0 ? '#667eea' : '#666';
                            }
                        }).catch(err => {
                            console.error(`åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥:`, err);
                        });
                    }, idx * 200);
                }
            });
        }

        function createTableRow(data, rowNum) {
            const { address, remark, summary, dailyStats } = data;
            
            // å¦‚æœæ²¡æœ‰summaryæˆ–dailyStats,è¯´æ˜æ•°æ®æœ‰é—®é¢˜
            if (!summary || !dailyStats) {
                return createErrorRow(data, rowNum);
            }
            
            const { totalVolume, qualifiedDays, partiallyQualifiedDays, totalDays, awards } = summary;

            // ç»Ÿè®¡éƒ¨åˆ†è¾¾æ ‡çš„å…·ä½“æƒ…å†µ
            let partialTradesOnly = 0;  // åªè¾¾æ ‡æ¬¡æ•°
            let partialVolumeOnly = 0;  // åªè¾¾æ ‡é‡‘é¢
            
            Object.values(dailyStats).forEach(stats => {
                if (stats.isPartiallyQualified) {
                    if (stats.isCountQualified) {
                        partialTradesOnly++;
                    } else if (stats.isVolumeQualified) {
                        partialVolumeOnly++;
                    }
                }
            });

            // æ„å»ºè¾¾æ ‡æ˜¾ç¤º
            // è®¡ç®—æ€»è¾¾æ ‡å¤©æ•°(åŒ…æ‹¬å®Œå…¨è¾¾æ ‡å’Œéƒ¨åˆ†è¾¾æ ‡)
            const totalQualifiedDays = qualifiedDays + partiallyQualifiedDays;
            
            // è·å–ä»Šå¤©çš„æ—¥æœŸ (UTC+0)
            const todayStr = getTodayUTC0();
            const todayStats = dailyStats[todayStr];
            
            // è®¡ç®—ä»Šæ—¥äº¤æ˜“é‡å’Œå·®é¢
            let todayVolume = 0;
            let todayTradeCount = 0;
            let todayGapVolume = 0;
            let todayGapTrades = 0;
            let todayGapText = '-';
            
            if (todayStats) {
                todayVolume = todayStats.totalVolume || 0;
                todayTradeCount = todayStats.tradeCount || 0;
                
                // è®¡ç®—å·®é¢
                todayGapVolume = MIN_VOLUME_PER_DAY - todayVolume;
                todayGapTrades = MIN_TRADES_PER_DAY - todayTradeCount;
                
                if (todayStats.isQualified) {
                    todayGapText = `<span style="color: #4caf50; font-weight: 600;">âœ… ${currentLang === 'zh' ? 'å·²è¾¾æ ‡' : 'Qualified'}</span>`;
                } else {
                    // æœªè¾¾æ ‡ï¼Œæ˜¾ç¤ºå·®é¢ï¼ˆæ¢è¡Œæ˜¾ç¤ºï¼‰
                    let gapLines = [];
                    if (todayGapTrades > 0) {
                        gapLines.push(`${currentLang === 'zh' ? 'æ¬¡æ•°' : 'Trades'}ï¼š${currentLang === 'zh' ? 'å·®' : '-'}${todayGapTrades}${currentLang === 'zh' ? 'æ¬¡' : ''}`);
                    }
                    if (todayGapVolume > 0) {
                        gapLines.push(`${currentLang === 'zh' ? 'é‡‘é¢' : 'Vol'}ï¼š${currentLang === 'zh' ? 'å·®' : '-'}$${todayGapVolume.toFixed(2)}`);
                    }
                    todayGapText = gapLines.length > 0 ? 
                        `<div style="color: #ff6b6b; font-size: 0.85em; line-height: 1.6;">${gapLines.join('<br>')}</div>` : '-';
                }
            }
            
            let todayIcon = '';
            let numberColor = '#888'; // é»˜è®¤ç°è‰²
            
            if (todayStats) {
                if (todayStats.isQualified) {
                    // ä»Šæ—¥å®Œå…¨è¾¾æ ‡ - æ•°å­—å’Œå›¾æ ‡éƒ½æ˜¯ç»¿è‰²
                    todayIcon = `<span style="color: #4caf50; font-weight: 600; margin-left: 2px;">âœ“</span>`;
                    numberColor = '#4caf50';
                } else if (todayStats.isPartiallyQualified) {
                    // ä»Šæ—¥éƒ¨åˆ†è¾¾æ ‡ - æ•°å­—ç»¿è‰²,å›¾æ ‡é»„è‰²
                    numberColor = '#4caf50';
                    if (todayStats.isCountQualified) {
                        todayIcon = `<span style="color: #ffa726; font-weight: 600; cursor: help; font-size: 1.2em; margin-left: 2px;" title="${currentLang === 'zh' ? 'ä»Šæ—¥ä»…è¾¾æ ‡æ¬¡æ•°' : 'Today trades only'}">â—</span>`;
                    } else if (todayStats.isVolumeQualified) {
                        todayIcon = `<span style="color: #ffa726; font-weight: 600; cursor: help; display: inline-block; transform: scaleX(-1); font-size: 1.2em; margin-left: 2px;" title="${currentLang === 'zh' ? 'ä»Šæ—¥ä»…è¾¾æ ‡é‡‘é¢' : 'Today volume only'}">â—</span>`;
                    }
                }
            }
            
            const qualifiedDisplay = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em;">
                    <span style="display: flex; align-items: center; gap: 2px;">
                        <span style="color: ${numberColor}; font-weight: 600;">${totalQualifiedDays}</span>${todayIcon}
                    </span>
                    <span style="color: #888;">/ 11</span>
                </div>
            `;

            const statusText = `
                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 0.85em;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${awards.dailyWarriors ? '#4caf50' : '#666'};">${awards.dailyWarriors ? 'âœ“' : 'âœ—'}</span>
                        <span data-i18n="daily_warrior">${i18n[currentLang].daily_warrior}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${awards.volumeKings ? '#4caf50' : '#666'};">${awards.volumeKings ? 'âœ“' : 'âœ—'}</span>
                        <span data-i18n="volume_king">${i18n[currentLang].volume_king}</span>
                    </div>
                </div>
            `;

            return `
                <tr class="expandable" onclick="toggleDetail(${rowNum})">
                    <td><span class="expand-icon" id="icon-${rowNum}">â–¶</span></td>
                    <td>${rowNum}</td>
                    <td class="address-cell">${address}</td>
                    <td class="account-info-cell" id="account-${address}" style="padding: 6px 8px 6px 2px; vertical-align: middle;">
                        <div style="font-size: 0.7em; color: #888; line-height: 1.3; white-space: nowrap;">
                            <div>æŒä»“: <span class="portfolio-val" style="color: #ffa726; font-weight: 600;">...</span></div>
                            <div>ä½™é¢: <span class="balance-val" style="color: #4caf50; font-weight: 600;">...</span></div>
                            <div>å‡€èµ„äº§: <span class="networth-val" style="color: #667eea; font-weight: 600;">...</span></div>
                        </div>
                    </td>
                    <td>${remark || '-'}</td>
                    <td style="font-size: 0.9em;">$${todayVolume.toFixed(2)}</td>
                    <td style="font-size: 0.85em; white-space: nowrap;">${todayGapText}</td>
                    <td>$${totalVolume.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${qualifiedDisplay}</td>
                    <td>${statusText}</td>
                    <td style="text-align: center; color: #667eea; cursor: pointer;" data-i18n="view">${i18n[currentLang].view}</td>
                </tr>
            `;
        }

        function createDetailRow(data, rowNum) {
            const { dailyStats, summary } = data;
            const dates = Object.keys(dailyStats).sort();
            
            // è®¡ç®—æ€»è¾¾æ ‡å¤©æ•°(åŒ…æ‹¬å®Œå…¨è¾¾æ ‡å’Œéƒ¨åˆ†è¾¾æ ‡)
            const totalQualifiedDays = summary.qualifiedDays + summary.partiallyQualifiedDays;
            
            // æ£€æŸ¥æ˜¯å¦å·²è¾¾æ ‡
            const isAlreadyQualified = totalQualifiedDays >= MIN_QUALIFIED_DAYS;
            
            // ä¿®æ”¹å‰©ä½™æ—¶é—´è®¡ç®—é€»è¾‘: ä»Šå¤©(å«)åˆ°1.5çš„å¤©æ•° >= è¿˜éœ€è¦çš„å¤©æ•°
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(END_DATE);
            endDate.setHours(23, 59, 59, 999);
            
            // è®¡ç®—ä»ä»Šå¤©(å«)åˆ°1.5çš„å¤©æ•°
            const remainingDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) + 1;
            
            // è®¡ç®—è¿˜éœ€è¦è¾¾æ ‡çš„å¤©æ•°
            const needDays = MIN_QUALIFIED_DAYS - totalQualifiedDays;
            
            // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æœºä¼š: å‰©ä½™å¤©æ•° >= è¿˜éœ€è¦çš„å¤©æ•°
            const canStillQualify = (remainingDays >= needDays);
            const noMoreChance = !isAlreadyQualified && !canStillQualify;

            let shortfallDetails = [];
            
            // ä½¿ç”¨UTC+0æ—¥æœŸåˆ¤æ–­"ä»Šå¤©åŠæœªæ¥"
            let todayDateStr = currentUTC0Date; // æ ¼å¼: "2025-12-26"
            if (!todayDateStr) {
                // å¤‡ç”¨ï¼šå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œä½¿ç”¨æœ¬åœ°UTCæ—¶é—´
                todayDateStr = new Date().toISOString().split('T')[0];
            }
            
            if (noMoreChance) {
                // æ— æ³•è¾¾æ ‡,ä¸æ˜¾ç¤ºå·®é¢
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰æ—¥æœŸï¼ˆä»12-22åˆ°1-5ï¼‰
                // æ— è®ºæ˜¯å¦å·²è¾¾æ ‡ï¼Œéƒ½æ˜¾ç¤º
                dates.forEach(dateStr => {
                    const stats = dailyStats[dateStr];
                    
                    // æ˜¾ç¤ºæ‰€æœ‰æ—¥æœŸï¼Œä¸åšä»»ä½•è¿‡æ»¤
                    let reasons = [];
                    
                    // å¦‚æœæœªè¾¾æ ‡ï¼Œæ˜¾ç¤ºå·®é¢åŸå› 
                    if (!stats.isQualified) {
                        if (stats.tradeCount < MIN_TRADES_PER_DAY) {
                            const gap = MIN_TRADES_PER_DAY - stats.tradeCount;
                            reasons.push(currentLang === 'zh' ? `äº¤æ˜“æ¬¡æ•°å·® ${gap} æ¬¡` : `Need ${gap} more trades`);
                        }
                        if (stats.totalVolume < MIN_VOLUME_PER_DAY) {
                            const gap = MIN_VOLUME_PER_DAY - stats.totalVolume;
                            reasons.push(currentLang === 'zh' ? `äº¤æ˜“é‡‘é¢å·® $${gap.toFixed(2)}` : `Need $${gap.toFixed(2)} more volume`);
                        }
                    }
                    
                    shortfallDetails.push({
                        date: dateStr,
                        trades: stats.tradeCount,
                        volume: stats.totalVolume,
                        reasons: reasons,
                        isQualified: stats.isQualified
                    });
                });
            }

            let statusMessage, shortfallTable;

            if (noMoreChance) {
                statusMessage = `<h4 style="color: #ff6b6b;">âš ï¸ ${currentLang === 'zh' ? 'å‰©ä½™æ—¶é—´ä¸è¶³,æ— æ³•è¾¾æ ‡' : 'Not enough time left'}</h4>`;
                shortfallTable = `<p style="color: #ff6b6b; padding: 20px 0;">${currentLang === 'zh' ? `å‰©ä½™æ—¶é—´ä¸è¶³,æ— æ³•è¾¾åˆ°${MIN_QUALIFIED_DAYS}å¤©è¦æ±‚` : `Not enough time to reach ${MIN_QUALIFIED_DAYS} days`}</p>`;
            } else if (isAlreadyQualified) {
                statusMessage = `<h4 style="color: #4caf50;">âœ… ${currentLang === 'zh' ? 'æ­å–œä½ è¾¾æ ‡äº†!' : 'Congratulations! You qualified!'}</h4>`;
                
                // å·²è¾¾æ ‡ä¹Ÿæ˜¾ç¤ºæ—¥æœŸè¡¨æ ¼
                if (shortfallDetails.length > 0) {
                    shortfallTable = `
                        <table style="width: 100%; font-size: 0.85em; margin-top: 10px;">
                            <thead>
                                <tr style="background: #1a1e3a;">
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'æ—¥æœŸ' : 'Date'}</th>
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'äº¤æ˜“æ¬¡æ•°' : 'Trades'}</th>
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'äº¤æ˜“é‡‘é¢' : 'Volume'}</th>
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'çŠ¶æ€' : 'Status'}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${shortfallDetails.map(item => {
                                    if (item.isQualified) {
                                        return `
                                            <tr style="border-bottom: 1px solid #2a2e4a;">
                                                <td style="padding: 8px;">${item.date}</td>
                                                <td style="padding: 8px;">${item.trades} ${currentLang === 'zh' ? 'æ¬¡' : ''}</td>
                                                <td style="padding: 8px;">$${item.volume.toFixed(2)}</td>
                                                <td style="padding: 8px; color: #4caf50;">âœ… ${currentLang === 'zh' ? 'å·²è¾¾æ ‡' : 'Qualified'}</td>
                                            </tr>
                                        `;
                                    } else {
                                        return `
                                            <tr style="border-bottom: 1px solid #2a2e4a;">
                                                <td style="padding: 8px;">${item.date}</td>
                                                <td style="padding: 8px;">${item.trades} ${currentLang === 'zh' ? 'æ¬¡' : ''}</td>
                                                <td style="padding: 8px;">$${item.volume.toFixed(2)}</td>
                                                <td style="padding: 8px; color: #ff6b6b;">${item.reasons.join(', ')}</td>
                                            </tr>
                                        `;
                                    }
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    shortfallTable = `<p style="color: #4caf50; font-size: 1.1em; padding: 20px 0;">ğŸ‰ ${currentLang === 'zh' ? `å·²è¾¾æ ‡ ${totalQualifiedDays} å¤©ï¼Œæ— éœ€è¡¥è¶³ï¼` : `${totalQualifiedDays} days qualified, no need to make up!`}</p>`;
                }
            } else {
                statusMessage = `<h4>ğŸ“Š ${currentLang === 'zh' ? `è¿˜å·® ${needDays} å¤©` : `Need ${needDays} more days`}</h4>`;
                
                // å¦‚æœæœ‰éœ€è¦è¡¥è¶³çš„æ—¥æœŸæ‰æ˜¾ç¤ºè¡¨æ ¼
                if (shortfallDetails.length > 0) {
                    shortfallTable = `
                        <table style="width: 100%; font-size: 0.85em; margin-top: 10px;">
                            <thead>
                                <tr style="background: #1a1e3a;">
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'æ—¥æœŸ' : 'Date'}</th>
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'äº¤æ˜“æ¬¡æ•°' : 'Trades'}</th>
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'äº¤æ˜“é‡‘é¢' : 'Volume'}</th>
                                    <th style="padding: 8px; text-align: left;">${currentLang === 'zh' ? 'å·®é¢åŸå› ' : 'Shortfall'}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${shortfallDetails.map(item => {
                                    if (item.isQualified) {
                                        // å·²è¾¾æ ‡ï¼Œæ˜¾ç¤ºç»¿è‰²
                                        return `
                                            <tr style="border-bottom: 1px solid #2a2e4a;">
                                                <td style="padding: 8px;">${item.date}</td>
                                                <td style="padding: 8px;">${item.trades} ${currentLang === 'zh' ? 'æ¬¡' : ''}</td>
                                                <td style="padding: 8px;">$${item.volume.toFixed(2)}</td>
                                                <td style="padding: 8px; color: #4caf50;">âœ… ${currentLang === 'zh' ? 'å·²è¾¾æ ‡' : 'Qualified'}</td>
                                            </tr>
                                        `;
                                    } else {
                                        // æœªè¾¾æ ‡ï¼Œæ˜¾ç¤ºçº¢è‰²å·®é¢
                                        return `
                                            <tr style="border-bottom: 1px solid #2a2e4a;">
                                                <td style="padding: 8px;">${item.date}</td>
                                                <td style="padding: 8px;">${item.trades} ${currentLang === 'zh' ? 'æ¬¡' : ''}</td>
                                                <td style="padding: 8px;">$${item.volume.toFixed(2)}</td>
                                                <td style="padding: 8px; color: #ff6b6b;">${item.reasons.join(', ')}</td>
                                            </tr>
                                        `;
                                    }
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    shortfallTable = `<p style="padding: 20px 0;">${currentLang === 'zh' ? 'ç»§ç»­ä¿æŒï¼Œå†å®Œæˆå‰©ä½™å¤©æ•°å³å¯è¾¾æ ‡ï¼' : 'Keep going, complete the remaining days!'}</p>`;
                }
            }

            const timeline = dates.map(dateStr => {
                const stats = dailyStats[dateStr];
                const [year, month, day] = dateStr.split('-');
                
                let className, statusText, statusIcon;
                if (stats.isQualified) {
                    className = 'qualified';
                    statusIcon = 'âœ“';
                    statusText = currentLang === 'zh' ? 'è¾¾æ ‡' : 'Qualified';
                } else if (stats.isPartiallyQualified) {
                    className = 'partially-qualified';
                    statusIcon = 'â—';
                    if (currentLang === 'zh') {
                        statusText = stats.isCountQualified ? 'ä»…è¾¾æ ‡æ¬¡æ•°' : 'ä»…è¾¾æ ‡é‡‘é¢';
                    } else {
                        statusText = stats.isCountQualified ? 'Trades only' : 'Volume only';
                    }
                } else {
                    className = 'not-qualified';
                    statusIcon = 'âœ—';
                    statusText = currentLang === 'zh' ? 'æœªè¾¾æ ‡' : 'Not Qualified';
                }

                return `
                    <div class="day-mini ${className}">
                        ${day}
                        <div class="tooltip">
                            ${dateStr}<br>
                            ${currentLang === 'zh' ? 'äº¤æ˜“' : 'Trades'}: ${stats.tradeCount}${currentLang === 'zh' ? 'æ¬¡' : ''}<br>
                            ${currentLang === 'zh' ? 'é‡‘é¢' : 'Volume'}: $${stats.totalVolume.toFixed(2)}<br>
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <tr class="detail-row" id="detail-${rowNum}">
                    <td colspan="11">>
                        <div class="detail-content">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                                <div class="detail-section">
                                    ${statusMessage}
                                    ${shortfallTable}
                                </div>
                                <div class="detail-section">
                                    <h4>ğŸ“Š ${currentLang === 'zh' ? 'æ¯æ—¥è¾¾æ ‡æƒ…å†µ' : 'Daily Status'}</h4>
                                    <div class="timeline-compact">${timeline}</div>
                                    <div style="margin-top: 15px; font-size: 0.85em; color: #888;">
                                        <div>ğŸŸ¢ ${currentLang === 'zh' ? 'ç»¿è‰² = è¾¾æ ‡' : 'Green = Qualified'} (${summary.qualifiedDays} ${currentLang === 'zh' ? 'å¤©' : 'days'})</div>
                                        <div>ğŸŸ¡ ${currentLang === 'zh' ? 'é»„è‰² = åªè¾¾æ ‡1é¡¹' : 'Yellow = Only 1 criteria met'} (${summary.partiallyQualifiedDays} ${currentLang === 'zh' ? 'å¤©' : 'days'})</div>
                                        <div>ğŸ”´ ${currentLang === 'zh' ? 'çº¢è‰² = æœªè¾¾æ ‡' : 'Red = Not Qualified'} (${summary.totalDays - summary.qualifiedDays - summary.partiallyQualifiedDays} ${currentLang === 'zh' ? 'å¤©' : 'days'})</div>
                                    </div>
                                    <div class="important-notice">
                                        <span class="important-notice-icon">ğŸ’¡</span>
                                        <span class="important-notice-text">${currentLang === 'zh' ? 'å»ºè®®ä¸è¦å¡çº¿,å¤šåšä¸€ç‚¹ä¼šæ›´å¥½!' : 'Tip: Don\'t cut it close, do a bit more for safety!'}</span>
                                    </div>
                                    
                                    <!-- å…³äºäº¤æ˜“ç¬”æ•° - ç²¾ç®€ç‰ˆ -->
                                    <div style="margin-top: 15px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-left: 3px solid #ff9800; border-radius: 4px; font-size: 0.75em; line-height: 1.5;">
                                        <div style="color: #ff9800; font-weight: 600; margin-bottom: 6px;">
                                            âš ï¸ ${currentLang === 'zh' ? 'å…³äºäº¤æ˜“ç¬”æ•°çš„é‡è¦è¯´æ˜' : 'About Trade Count'}
                                        </div>
                                        <div style="color: #ccc;">
                                            ${currentLang === 'zh' ? 
                                                'æœ‰äººè¯´ä»¥ä¸‹å•ç¬”æ•°ä¸ºå‡†ï¼Œæœ‰äººè¯´ä»¥é“¾ä¸Štxè®°å½•ä¸ºå‡†ï¼Œå…³äºäº¤æ˜“ç¬”æ•°æœ‰äº‰è®®ã€‚<br>' +
                                                'æœ¬å·¥å…·æŸ¥è¯¢çš„æ˜¯<strong>é“¾ä¸Šäº¤æ˜“è®°å½•(tx)ç¬”æ•°</strong>ï¼Œä¸å®˜ç½‘"å·²å…³é—­è®¢å•"å¯èƒ½ä¸ä¸€è‡´ã€‚<br>' +
                                                '<span style="color: #ff9800;">ğŸ’¡ å»ºè®®ï¼šä¸‹å•æ—¶å¤šä¸‹å‡ ä¸ªå•ï¼Œå¤šäº†æ²¡äº‹ï¼Œå°‘äº†è¡€äºã€‚</span>'
                                                : 
                                                'Dispute: "order count" vs "on-chain tx records".<br>' +
                                                'This tool uses <strong>on-chain tx records</strong>, may differ from official site.<br>' +
                                                '<span style="color: #ff9800;">ğŸ’¡ Tip: Place more orders to be safe.</span>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
        function createErrorRow(result, rowNum) {
            return `
                <tr>
                    <td></td>
                    <td>${rowNum}</td>
                    <td class="address-cell">${result.address}</td>
                    <td></td>
                    <td>${result.remark || '-'}</td>
                    <td colspan="4" style="color: #f44336;">âŒ ${result.error}</td>
                </tr>
            `;
        }

        function toggleDetail(rowNum) {
            const detailRow = document.getElementById(`detail-${rowNum}`);
            const icon = document.getElementById(`icon-${rowNum}`);
            
            if (detailRow.classList.contains('expanded')) {
                detailRow.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                detailRow.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
